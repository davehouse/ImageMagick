sudo: required # needed for trusty beta
dist: trusty   # needed for HarfBuzz

language: c

compiler:
  - clang
  - gcc

before_script:
  - sudo add-apt-repository -y ppa:as-bahanta/raqm
  - sudo add-apt-repository ppa:dns/gnu -y
  - sudo apt-key update -q
  - sudo apt-get update -q
  - sudo apt-get install --only-upgrade autoconf
  - sudo apt-get install -y libraqm-dev libfreetype6-dev libharfbuzz-dev libfribidi-dev

script: |
  set -e
  set -x
  export CFLAGS="-Wno-deprecated-declarations -Wdeclaration-after-statement -Wno-error=unused-variable"
  if [ "$TRAVIS_COMPILER" == "gcc" ] ; then
    ./configure --with-quantum-depth=16 --enable-hdri=no --without-perl --prefix=/usr
  else
    ./configure --disable-openmp --with-quantum-depth=16 --enable-hdri=no --without-perl --prefix=/usr
  fi
  make
  mkdir out-build
  mkdir out-dmg
  make DEST_DIR=$PWD/out-build install
  pkgbuild --root ./out-build/ -i com.imagemagick --install-location / out-dmg/imagemagick.pkg
  hdiutil makehybrid -hfs -hfs-volume-name imagemagick -o ./imagemagick.dmg out-dmg
  hdiutil attach imagemagick.dmg
  ls -la /Volumes/imagemagick/
  sudo installer -package /Volumes/imagemagick/imagemagick.pkg -target /
  ls -la /usr/local/bin/magick || true
  hdiutil detach /Volumes/imagemagick
  magick logo: logo.gif
  identify logo.gif
deploy:
  provider: releases
  api_key:
    secure: em0npNCc+tp/KLC5XCyYlnwQEWQk/aoHRb/WvmUnmuBMqIUPzzWDzK9VfZb3JicIE2kJ20mYG+taacaDV4fZQS/9E5aXrqNQ9w2NflWNuMQauQ4zYi22zRgt+cveniAMFF+IRgc65ZeEoi0g9Lh8kxewnZP7a3OkCoUq44tWA3pEFW9zoJKkZSQMPm6loOS5rBGKgvk9HpIqTd/bFf9vnbBcIYWYcirSLcVi4AXkweD4my9Tw6nQ9NMRxh5qO6xpg1Jtb4N83OfMU5DFC/KVouah82yNr9/lUY3RiCLwoBb590OlMC2PcdKMSpw//gPNbkTyqAdJkVh+K5PDngxP6nCecPs31xj7DhBOx44yDQf++vBFIefsfo8i/dMSZxJPo066jaBSZPpY54YtMIWBhdAFnutJYeuZtAr5NTnied6E22CEYUXVySipkXpvBaTVCp5C5ssJDZc9fgMtQar/ae9GnFbtgJWlf3yYT0sv7NoR54nfx4YRMcD8fASvcYvG0VybDqK+6lAsk+tK5tzsbNvj8or+lpDzxIDsJpCJ/zHvzFqC3QfcsGyshORMUPpEmXPSgnhkWvz0p2ao+yH7lQ8hSkz8yDEqNFHIn/Np3uAt4SHmCfXurxNnBBKYW1PdpQaDyj5yIjavFi/ZlcvqoD0yAFczxJIe4GQCumJRE2A=
  file: imagemagick.dmg
  on:
    all_branches: true
  skip_cleanup: 'true'
